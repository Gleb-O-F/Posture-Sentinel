# План реализации AI Posture Sentinel

## Фаза 0: Проверка работоспособности (ПРИОРИТЕТ, 0.5-1 день)

### 0.1 Тест камеры ноутбука
- [ ] Создать минимальный скрипт на Python/Rust для захвата видео
- [ ] Проверить доступность камеры (индекс 0, 1, ...)
- [ ] Протестировать разрешение и FPS
- [ ] Убедиться в стабильности видеопотока (без зависаний)

### 0.2 Тест модели BlazePose
- [ ] Скачать/конвертировать модель в ONNX формат
- [ ] Создать тестовый скрипт инференса (Python + onnxruntime-gpu)
- [ ] Проверить работу на CUDA (Quadro P1000)
- [ ] Замерить производительность:
  - Время инференса на один кадр
  - Загрузка GPU
  - Достижимый FPS
- [ ] Визуализировать результат (наложить landmarks на кадр)

### 0.3 Критерии успеха
- ✅ Камера захватывает видео без ошибок
- ✅ Модель выдает 33 ключевые точки
- ✅ FPS ≥ 20 на GPU
- ✅ Загрузка GPU ≤ 20%

**Если тесты провалены**: пересмотреть выбор модели или оптимизировать pipeline

---

## Фаза 1: Подготовка окружения (1-2 дня)

### 1.1 Установка зависимостей
- [ ] Установить Rust toolchain (rustup)
- [ ] Установить CUDA Toolkit 11.x/12.x (совместимый с Quadro P1000)
- [ ] Установить OpenCV (через vcpkg или системный пакетный менеджер)
- [ ] Проверить работу `cargo build`

### 1.2 Получение модели
- [ ] Скачать BlazePose ONNX модель (MediaPipe или конвертировать из TFLite)
- [ ] Оптимизировать модель для FP16 (через onnxruntime или polygraphy)
- [ ] Протестировать инференс на GPU (проверить загрузку GPU ~15%)

---

## Фаза 2: Базовая инфраструктура (2-3 дня)

### 2.1 Модуль захвата видео (`camera.rs`)
- [ ] Реализовать инициализацию VideoCapture
- [ ] Добавить обработку ошибок (камера занята, не найдена)
- [ ] Настроить разрешение и FPS (640x480 @ 30fps)
- [ ] Тестирование: вывод кадров в окно OpenCV

### 2.2 Модуль инференса (`inference.rs`)
- [ ] Загрузка ONNX модели с CUDA Execution Provider
- [ ] Препроцессинг кадра (resize, normalize, BGR→RGB)
- [ ] Постпроцессинг выхода модели (извлечение 33 landmarks)
- [ ] Тестирование: вывод координат ключевых точек в консоль

### 2.3 Модуль конфигурации (`config.rs`)
- [ ] Добавить поля для калибровки (baseline_shoulder_y, baseline_ear_distance)
- [ ] Реализовать сохранение/загрузку из `config.toml`
- [ ] Валидация параметров

---

## Фаза 3: Логика детекции осанки (3-4 дня)

### 3.1 Калибровка (`posture.rs`)
- [ ] Реализовать функцию `calibrate()`
  - Извлечь точки: плечи (11, 12), уши (7, 8)
  - Вычислить `y_base` (средняя высота плеч)
  - Вычислить `d_base` (расстояние между ушами)
- [ ] Сохранить baseline в config.toml
- [ ] UI: кнопка "Откалибровать" (временно через консоль)

### 3.2 Детекция нарушений
- [ ] **Сутулость**: `current_shoulder_y < baseline_shoulder_y - threshold`
- [ ] **Наклон вперед**: `current_ear_distance > baseline_ear_distance * 1.15`
- [ ] **Наклон головы**: угол между векторами плеч и ушей > 15°
- [ ] Добавить таймер: нарушение фиксируется только если длится > 3 сек

### 3.3 Тестирование
- [ ] Юнит-тесты для геометрических расчетов
- [ ] Ручное тестирование с разными позами

---

## Фаза 4: Система уведомлений (2-3 дня)

### 4.1 Оверлей размытия (`overlay.rs`)
- [ ] Создать полноэкранное прозрачное окно (winit)
- [ ] Реализовать постепенное размытие:
  - Вариант 1: `window-vibrancy` (Acrylic эффект Windows)
  - Вариант 2: Custom shader с wgpu/pixels
- [ ] Градиентная интенсивность: 0% → 80% за 10 секунд

### 4.2 Интеграция с детектором
- [ ] При нарушении: запустить таймер размытия
- [ ] При исправлении осанки: плавно убрать размытие
- [ ] Логирование событий (опционально)

---

## Фаза 5: Оптимизация и полировка (2-3 дня)

### 5.1 Производительность
- [ ] Профилирование (cargo flamegraph)
- [ ] Оптимизация препроцессинга (использовать GPU если возможно)
- [ ] Проверить целевые метрики:
  - FPS: 20-30
  - GPU usage: ≤15%
  - CPU usage: ≤5%

### 5.2 Стабильность
- [ ] Обработка отключения камеры
- [ ] Graceful shutdown
- [ ] Логирование ошибок

### 5.3 UX улучшения
- [ ] Системный трей (опционально)
- [ ] Горячие клавиши (пауза, калибровка)
- [ ] Визуальная индикация статуса

---

## Фаза 6: Упаковка и документация (1 день)

### 6.1 Сборка релиза
- [ ] `cargo build --release`
- [ ] Упаковать с зависимостями (ONNX Runtime DLL, OpenCV DLL)
- [ ] Создать installer (опционально: WiX или Inno Setup)

### 6.2 Документация
- [ ] Обновить README.md (инструкция по установке)
- [ ] Добавить troubleshooting секцию
- [ ] Документировать config.toml параметры

---

## Риски и митигация

| Риск | Вероятность | Митигация |
|------|-------------|-----------|
| Модель BlazePose работает медленно на Pascal GPU | Средняя | Использовать FP16/INT8 квантизацию, уменьшить входное разрешение |
| OpenCV не собирается на Windows | Средняя | Использовать предсобранные бинарники (vcpkg) |
| Размытие экрана лагает | Низкая | Использовать нативный Windows Acrylic вместо custom shader |
| Ложные срабатывания детектора | Высокая | Добавить сглаживание (moving average), увеличить timeout |

---

## Итоговая оценка: 11-16 дней разработки
